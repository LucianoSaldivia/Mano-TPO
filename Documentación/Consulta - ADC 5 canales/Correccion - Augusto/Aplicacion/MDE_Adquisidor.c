/*******************************************************************************************************************************//**
 *
 * @file		MDE_Adquisidor.c
 * @brief		--Descripción del Módulo--
 * @date		22/10/2018
 * @author		Esteban Chiama
 *
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/


#include "MDE_Adquisidor.h"


/***********************************************************************************************************************************
 *** DEFINES PRIVADOS AL MODULO
 **********************************************************************************************************************************/


// Constantes para el estado del medidor
#define MEDIDOR_RESET		0
#define	MEDIDOR_INACTIVO	1
#define	MEDIDOR_ACTIVO		2


/***********************************************************************************************************************************
 *** MACROS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TIPOS DE DATOS PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TABLAS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PUBLICAS
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PRIVADAS AL MODULO
 **********************************************************************************************************************************/


static volatile uint32_t estado_medidor = MEDIDOR_RESET;


/***********************************************************************************************************************************
 *** PROTOTIPO DE FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES GLOBALES AL MODULO
 **********************************************************************************************************************************/


void MDE_Adquisidor(void) {

	// MdE: medición del ADC y transmisión de datos
	switch (estado_medidor) {

		case MEDIDOR_RESET:
			LCD_DisplayMsg("> INACTIVO.     ", LCD_RENGLON_1, 0);
			LCD_DisplayMsg("> INFOII MANO TP", LCD_RENGLON_2, 0);
			estado_medidor = MEDIDOR_INACTIVO;
			break;

		case MEDIDOR_INACTIVO:
			// caso: comando para iniciar muestreo
			if ( command == START_ADC ) {
				command = NO_COMMAND;
				estado_medidor = MEDIDOR_ACTIVO;
				ResetBuffers();
				Start_Sampling();
				LCD_DisplayMsg("> MUESTREANDO.  ", LCD_RENGLON_1, 0);
				IO_LED_Set(IO_LED_STICK, 0);	// prendo el led del stick, como testigo
			}
			break;


		case MEDIDOR_ACTIVO:
			// caso: muestra lista, la envío por el puerto serie
			if (ADC_dato_disponible) {
				ADC_dato_disponible = 0;
				Preparar_y_Enviar();
			}
			// caso: comando para detener muestreo
			if ( command == STOP_ADC ) {
				command = NO_COMMAND;
				estado_medidor = MEDIDOR_INACTIVO;
				Stop_Sampling();
				LCD_DisplayMsg("> INACTIVO     ", LCD_RENGLON_1, 0);
				IO_LED_Set(IO_LED_STICK, 1);	// apago el led del stick
			}
			break;

		default:
			estado_medidor = MEDIDOR_INACTIVO;
			break;
	}
}
